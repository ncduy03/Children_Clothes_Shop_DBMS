<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khách hàng</title>
    <link href="/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script defer src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script defer src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script defer src="script.js"></script>

</head>

<body>

    <nav class="navbar navbar-expand-xxl bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/tongquan">
                <img src="/img/navbar/logo.svg" alt="Logo" width="30" height="24" class="d-inline-block align-text-top">
                My Store
            </a>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/tongquan">
                            <img src="/img/navbar/tongquan.svg">
                            Tổng quan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/hanghoa">
                            <img src="/img/navbar/box.svg">
                            Hàng hóa
                        </a>
                    </li>
                    <li class="nav-item dropdown">

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <img src="/img/navbar/giaodich.svg">
                            Giao dịch
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="/nhaphang">
                                    <img src="/img/navbar/thietlapgia.svg">
                                    Nhập hàng
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/banhang">
                                    <img src="/img/navbar/kiemkho.svg">
                                    Bán hàng
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/doitac">
                            <img src="/img/navbar/doitac.svg">
                            Đối tác
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/nhanvien">
                            <img src="/img/navbar/nhanvien.svg">
                            Nhân viên
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/khachhang">
                            <img src="/img/navbar/khachhang.svg">
                            Khách hàng
                        </a>
                    </li>
                    </li>
                </ul>
            </div>
            <a class="nav-link" href="/login">Logout</a>
        </div>
    </nav>


    <div class="row">
        <div class="col-6 text-start">
            <p class="fs-2 mt-3 ms-4">Khách hàng</p>
        </div>
        <div class="col-6 text-end">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary mt-4 me-4" data-bs-toggle="modal"
                    data-bs-target="#exampleModal">
                    Thêm khách hàng
                </button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm khách hàng</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/khachhang/add" method="post">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Họ và tên</label>
                                <input type="text" name="ten" id="ten" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Số điện thoại</label>
                                <input type="text" name="phone" id="phone" class="form-control">
                            </div>
                        </div>
                </div>
                <div class="modal-footer">
                    <div class="mb-3">
                        <input type="submit" name="submit_button" class="btn btn-primary" value=" Add">
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Chỉnh sửa thông tin khách hàng</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/khachhang/chinhsua" method="post" id="updateForm">
                        <div class="form-group">
                            <label for="customerId">Mã khách hàng:</label>
                            <span id="customerId"></span>
                        </div>
                        <div class="mb-3">
                            <label for="newName">Họ và tên</label>
                            <input type="text" name="newName" id="newName" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="newPhone">Số điện thoại</label>
                            <input type="text" name="newPhone" id="newPhone" class="form-control">
                        </div>
                        <input type="hidden" name="customerId" id="customerIdInput" value="">
                    </form>
                </div>
                <div class="modal-footer">
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="updateButton">Lưu</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid-container">
        <div class="grid-item">
            <p class="fs-5 ms-2">Tìm khách hàng</p>
            <form action="/khachhang" method="post">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Họ và tên" name="input_data1">
                    <button class="btn btn-outline-dark" type="submit">Find</button>
                </div>
            </form>
            <form action="/khachhang" method="post">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Số điện thoại" name="input_data2">
                    <button class="btn btn-outline-dark" type="submit">Find</button>
                </div>
            </form>

        </div>
        <div class="grid-item">
            <div class="container">
                <table id="example" class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Mã khách hàng</th>
                            <th scope="col">Họ và tên</th>
                            <th scope="col">Số điện thoại</th>
                            <th scope="col">Sửa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let i=0; i < dulieu.length; i++) { %>
                            <tr>
                                <td id="customerId">
                                    <%= dulieu[i].customer_id %>
                                </td>
                                <td>
                                    <%= dulieu[i].name %>
                                </td>
                                <td>
                                    <%= dulieu[i].phone %>
                                </td>
                                <td data-bs-toggle="modal" data-bs-target="#detailModal" class="text-center"
                                    data-inbound-order-id="<%= dulieu[i].customer_id %>">
                                    <img src="/img/navbar/pencil.svg">
                                </td>
                            </tr>
                            <% } %>
                    </tbody>
                </table>
            </div>

        </div>
    </div>


    <script>
        // Đặt sự kiện click cho nút cập nhật khi trang được tải
        $(document).ready(function () {
            $('#updateButton').click(function () {
                // Gửi yêu cầu AJAX để cập nhật thông tin khách hàng
                $.ajax({
                    type: 'POST',
                    url: '/khachhang/chinhsua',
                    data: $('#updateForm').serialize(),
                    success: function (response) {
                        // Xử lý phản hồi từ server nếu cần
                        console.log(response);
                        // Đóng modal
                        $('#detailModal').modal('hide');
                        location.reload();
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            });

            // Gán sự kiện cho modal khi nó được hiển thị
            $('#detailModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var customerId = button.data('inbound-order-id');
                var modal = $(this);

                // Gửi yêu cầu AJAX để lấy thông tin khách hàng dựa trên customerId
                $.ajax({
                    type: 'POST',
                    url: '/khachhang/chinhsua/info',
                    data: { customerId: customerId },
                    success: function (data) {
                        // Điền thông tin vào form
                        modal.find('#customerId').text(data.customer_id);
                        modal.find('#newName').val(data.name);
                        modal.find('#newPhone').val(data.phone);
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            });
        });        
    </script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="./index.js" charset="UTF-8"></script>
</body>

</html>