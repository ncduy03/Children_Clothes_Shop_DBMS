<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bán hàng</title>
    <link href="/style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script defer src="script.js"></script>

</head>

<body>
    <nav class="navbar navbar-expand-xxl bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/tongquan">
                <img src="/img/navbar/logo.svg" alt="Logo" width="30" height="24" class="d-inline-block align-text-top">
                My Store
            </a>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/tongquan">
                            <img src="/img/navbar/tongquan.svg">
                            Tổng quan
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/hanghoa">
                            <img src="/img/navbar/box.svg">
                            Hàng hóa
                        </a>
                    </li>
                    <li class="nav-item dropdown">

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <img src="/img/navbar/giaodich.svg">
                            Giao dịch
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="/nhaphang">
                                    <img src="/img/navbar/thietlapgia.svg">
                                    Nhập hàng
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/banhang">
                                    <img src="/img/navbar/kiemkho.svg">
                                    Bán hàng
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/doitac">
                            <img src="/img/navbar/doitac.svg">
                            Đối tác
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/nhanvien">
                            <img src="/img/navbar/nhanvien.svg">
                            Nhân viên
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/khachhang">
                            <img src="/img/navbar/khachhang.svg">
                            Khách hàng
                        </a>
                    </li>
                    </li>
                </ul>
            </div>
            <a class="nav-link" href="/login">Logout</a>
        </div>
    </nav>

    <!-- <p class="fs-2 mt-3 ms-4">Bán hàng</p>

    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        Thêm đơn hàng
    </button> -->

    <div class="row">
        <div class="col-6 text-start">
            <p class="fs-2 mt-3 ms-4">Bán hàng</p>
        </div>
        <div class="col-6 text-end">
            <button type="button" class="btn btn-outline-secondary mt-4 me-4" data-bs-toggle="modal"
                data-bs-target="#exampleModal">
                Thêm đơn hàng
            </button>
            <p id='testobas'></p>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm đơn hàng</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/banhang/add" method="post">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Mã khách hàng</label>
                                <input type="number" name="ma" id="ma" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Mã nhân viên</label>
                                <input type="number" name="ma_nhanvien" id="ma_nhanvien" class="form-control">
                            </div>
                        </div>

                </div>
                <div class="modal-footer">
                    <div class="mb-3">
                        <input type="submit" name="submit_button" class="btn btn-primary" value="Save">
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm hàng hóa</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/banhang/chitiet/add" method="post">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Mã hàng hóa</label>
                                <input type="number" name="cus_detail_id" id="cus_detail_id" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Số lượng</label>
                                <input type="number" name="cus_detail_status" id="cus_detail_status"
                                    class="form-control">
                            </div>
                        </div>

                </div>
                <div class="modal-footer">
                    <div class="mb-3">
                        <input type="submit" name="submit_button" class="btn btn-primary" value="Save">
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="removeModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Xóa hàng hóa</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/banhang/chitiet/xoa" method="post">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label>Mã hàng hóa</label>
                                <input type="number" name="cus_detail_id1" id="cus_detail_id1" class="form-control">
                            </div>
                        </div>

                </div>
                <div class="modal-footer">
                    <div class="mb-3">
                        <input type="submit" name="submit_button" class="btn btn-primary" value="Save">
                    </div>
                </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal hide fade" id="detailModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Chi tiết đơn hàng</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal_body">
                    <p id="modal_body"></p>


                    <table class="table table-striped table-hover table-bordered" id="my_table">

                        <thead>
                            <tr>
                                <th scope="col">Mã hàng hóa</th>
                                <th scope="col">Tên hàng hóa</th>
                                <th scope="col">Số lượng</th>
                                <th scope="col">Số tiền</th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="add" data-bs-toggle="modal"
                        data-bs-target="#addModal">Thêm</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                        data-bs-target="#removeModal">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="updateStatus" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="myModalLabel">Thay đổi trạng thái</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/banhang/update" method="post" id="updateForm">
                        <div class="form-group">
                            <label for="customer_order_id">Mã đơn hàng:</label>
                            <span id="customer_order_id"></span>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="newName">Trạng thái:</label>
                                <input type="text" name="status" id="status" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-12">
                            <input type="hidden" name="customer_order_idInput" id="customer_order_idInput" value="">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="updateButton"
                        data-bs-dismiss="modal">Save</button>
                </div>
                </form>
            </div>
        </div>
    </div>

    <div class="grid-container">
        <div class="grid-item">
            <p class="fs-5 ms-2">Tìm đơn hàng</p>
            <form action="/banhang" method="post">
                <div class="input-group mb-3">
                    <input type="date" class="form-control" placeholder="Time start" name="input_data1">
                </div>
                <div class="input-group mb-3">
                    <input type="date" class="form-control" placeholder="Time end" name="input_data2">
                </div>

                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="checked1" id="checked1" value="true"
                        onchange="sendData('checked1')">
                    <label class="form-check-label" for="checked1">
                        Đã thanh toán
                    </label>
                </div>


                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="checked2" id="checked2" value="true"
                        onchange="sendData('checked2')">
                    <label class="form-check-label" for="checked2">
                        Đã hủy
                    </label>
                </div>


                <button class="btn btn-outline-dark" type="submit">Find</button>
            </form>
        </div>

        <div class="grid-item">
            <div class="container">
                <table id="example" class="table table-striped table-hover table-bordered">
                    <thead>
                        <tr>
                            <th scope="col">Mã hóa đơn</th>
                            <th scope="col">Tên khách hàng</th>
                            <th scope="col">Thời gian</th>
                            <th scope="col">Tổng số tiền</th>
                            <th scope="col">Trạng thái</th>
                            <th scope="col">Chi tiết</th>
                            <th scope="col">Thay đổi trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let i=0; i < dulieu.length; i++) { %>
                            <tr>
                                <td>
                                    <%= dulieu[i].customer_order_id %>
                                </td>
                                <td>
                                    <%= dulieu[i].name %>
                                </td>
                                <td>
                                    <%= new Date(dulieu[i].order_date).toLocaleString(undefined, { timeZone: 'UTC' }) %>
                                </td>
                                <td>
                                    <%= dulieu[i].TP %>
                                </td>
                                <td>
                                    <%= dulieu[i].status %>
                                </td>
                                <td data-bs-toggle="modal" data-bs-target="#detailModal" class="text-center-click"
                                    data-customer-order-id="<%= dulieu[i].customer_order_id %>">
                                    <img src="/img/navbar/pencil.svg">
                                </td>
                                <td data-bs-toggle="modal" data-bs-target="#updateStatus" class="text-center"
                                    data-customer-order-id="<%= dulieu[i].customer_order_id %>">
                                    <img src="/img/navbar/pencil.svg">
                                </td>
                                <% } %>
                            </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <script>
        function sendData(checkboxName) {
            // Lấy giá trị của checkbox
            var checkbox = document.getElementById(checkboxName);
            var isChecked = checkbox.checked;

            // Nếu checkbox được chọn, gửi giá trị 1 đến máy chủ
            if (isChecked) {
                // Thực hiện yêu cầu AJAX hoặc sử dụng fetch API để gửi dữ liệu đến máy chủ
                // Ở đây tôi sử dụng fetch API làm ví dụ
                fetch('/banhang/check1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ [checkboxName]: true }),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Success:', data);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
        }
    </script>
    <script>
        $(document).ready(function () {
            var customerOrderId;
            // When a <td> with the class 'text-center' is clicked
            $('td.text-center-click').click(function () {
                // Get the customer_order_id from the data attribute
                customerOrderId = $(this).data('customer-order-id');
                // Send an AJAX request to the server
                $.ajax({
                    type: 'POST',
                    url: '/banhang/chitiet',  // Specify the server endpoint
                    data: { customerOrderId: customerOrderId },
                    success: function (data) {
                        var dulieu2 = data.dulieu2;
                        var tableBody = $('#my_table tbody'); // Thay yourTableId bằng ID thực tế của bảng
                        var modalBodyContent = '';
                        var date = new Date(dulieu2[0].order_date).toLocaleString(undefined, { timeZone: 'UTC' });
                        // Tạo nội dung cho thẻ p từ dulieu2
                        modalBodyContent += 'Mã hóa đơn: ' + dulieu2[0].customer_order_id + '<br>' + 'Tên khách hàng: ' + dulieu2[0].cname + '<br>' + ' Số điện thoại: ' + dulieu2[0].phone + '<br>' + 'Thời gian: ' + date + '<br>';

                        // Đặt nội dung vào thẻ p
                        $('#modal_body').html(modalBodyContent);
                        // Xóa nội dung hiện tại của bảng
                        tableBody.empty();

                        // Thêm dữ liệu từ dulieu2 vào bảng
                        for (var i = 0; i < dulieu2.length; i++) {
                            var row = '<tr>' +
                                '<td>' + dulieu2[i].product_id + '</td>' +
                                '<td>' + dulieu2[i].pname + '</td>' +
                                '<td>' + dulieu2[i].quantity + '</td>' +
                                '<td>' + dulieu2[i].TP + '</td>' +
                                '</tr>';

                            tableBody.append(row);
                        }

                        // Show the modal
                        $('#detailModal').modal('show');
                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            });
            $('#addModal form').submit(function (e) {
                e.preventDefault();

                // Lấy giá trị từ các trường nhập liệu
                var cusDetailId = $('#cus_detail_id').val();
                var cusDetailStatus = $('#cus_detail_status').val();

                // Gửi AJAX request lên server cùng với customerOrderId
                $.ajax({
                    type: 'POST',
                    url: '/banhang/chitiet/add',
                    data: {
                        customerOrderId: customerOrderId,
                        cusDetailId: cusDetailId,
                        cusDetailStatus: cusDetailStatus
                    },
                    success: function (data) {
                        // Xử lý dữ liệu nhận được từ server nếu cần
                        location.reload();


                    },
                    error: function (error) {
                        $('#testobas').html("Không thể insert!");
                        console.error('Error:', error);
                        location.reload();
                    }
                });
            });
            $('#removeModal form').submit(function (e) {
                e.preventDefault();

                // Lấy giá trị từ các trường nhập liệu
                var cusDetailId = $('#cus_detail_id1').val();

                // Gửi AJAX request lên server cùng với customerOrderId
                $.ajax({
                    type: 'POST',
                    url: '/banhang/chitiet/xoa',
                    data: {
                        customerOrderId: customerOrderId,
                        cusDetailId: cusDetailId,
                    },
                    success: function (data) {
                        // Xử lý dữ liệu nhận được từ server nếu cần
                        location.reload();


                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            });
            // Set up the event listener for the product update button
            $('#updateButton').click(function () {
                // Make an AJAX request to update the product details
                $.ajax({
                    type: 'POST',
                    url: '/banhang/update',
                    data: $('#updateForm').serialize(),
                    success: function (response) {
                        // Handle the server response if needed
                        console.log(response);
                        // Close the modal
                        $('#detailModal').modal('hide');
                        // Reload the page or update the data as needed
                        location.reload();
                    },
                    error: function (error) {
                        console.error(error);
                    }
                });
            });

            // Set up the modal event when it's shown
            $('#updateStatus').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var customer_order_id = button.data('customer-order-id');
                var modal = $(this);

                // Make an AJAX request to get product details based on productCode
                $.ajax({
                    type: 'POST',
                    url: '/banhang/chinhsua/info',
                    data: { customer_order_id: customer_order_id },
                    success: function (data) {
                        // Fill in the form with product details
                        modal.find('#status').val(data.status);
                        modal.find('#customer_order_id').text(data.customer_order_id);

                        modal.find('#customer_order_idInput').val(data.customer_order_id);


                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            });
        });

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

</body>

</html>